---
title: "Modelling the demographic distribution of the global refugee population"
author: "Sebastian Steinmueller (UNHCR)"
date: 'Version: `r Sys.Date()`'
output:
  bookdown::html_document2: 
    df_print: paged
    number_sections: false 
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
## run code to create descriptive figures and tables

source("descriptives.R")

```


# Introduction

# Descriptive analysis
- Describe UNHCR official population statistics content and compilation
- Show and explore structure of data sets: especially asylum - origin - location
- Show origin and asylum country structure in missing and non-missing demographic data
- Explore differences in demographic structure for origin and asylum countries with high proportion of available data




## Data set

UNHCR compiles official statistics on stocks and flows of forcibly displaced and stateless persons twice a year, once for mid-year figures (Mid-Year Statistical Reporting, MYSR) and once for end-year figures (Annual Statistical Reporting, ASR). For these reporting exercises, country operations compile aggregate population figures from a range of sources and data producers such as governments, UNHCR's own refugee registration database proGres and sometimes non-governmental actors. The figures undergo a statistical quality control process at the country, regional and global level of the organisation and are disseminated on the publicly available refugee data finder (https://www.unhcr.org/refugee-statistics/) after applying statistical disclosure control to suppress very small counts of persons that could identify individuals. 

The end-year figures compiled with reporting date 31 December contain sex- and age breakdowns of the stocks of displaced and stateless people under UNHCR's mandate. Table \@ref(tab:demref). displays the sex- and age-disaggregated data on the stock of refugees under UNHCR's mandate (including Venezuelans displaced abroad, excluding Palestine refugees under UNRWA's mandate). The data is available by country of origin, country of asylum and within country of asylum on sub-national level as indicated by the variables _location_ and _urbanRural_. Variable _statelessStatus_ displays whether the reported population is stateless ("STL" and "UDN") or not stateless ("NSL"). The variables [sex]_[agebracket] contain the counts of refugees as of 31 December 2020 in the individual sex and age brackets in the respective geographic/stateless combination. For example, _female_12_17_ contains the number of female refugees aged 12 to 17. Variable _totalEndYear_ is the total number of refugees over all sex/age categories. 
 

 
Pre-defined sex-specific age brackets are 0-4, 5-11, 12-17, 18-24, 25-49, 50-59 and 60 years and older. For some population groups, data is only available for the overall 18-59 age group instead of for the finer brackets in this age range. For others, only sex-disaggregated data without age information is available, and finally there are population groups for which only the total end-year count without any demographic information is available. These different levels of disaggregated data availability is recorded in variable _typeOfDisaggregation_ in the dataset: "Sex/Age fine" for the most granular age brackets, "Sex/Age broad" for populations reported with the 18-59 age bracket, "Sex" where only counts of female and male refugees are available without age information and "None" for populations without any available demographic information.

```{r demref, echo = F}
demref2020 %>% 
  select(asylum_country, origin_country, location, urbanRural, statelessStatus, female_0_4:totalEndYear, typeOfDisaggregation, typeOfDisaggregationBroad) %>% head() %>% kable(format = 'html', caption =  "Demographic breakdown of UNHCR refugee population end 2020") %>%
  kable_styling()%>%
  scroll_box(width = "100%", box_css = "border: 0px;")
``` 

## Distribution of missing and observed demographic data

```{r typeOfDisaggregation, echo=F}
t.typeOfDisaggregation %>% select(typeOfDisaggregation, totalEndYear, freq.totalEndYear, nAsylum, freq.asylum) %>% kable(format = 'html', caption =  "Demographic breakdown of UNHCR refugee population end 2020") %>% kable_styling()
``` 

Table \@ref(tab:typeOfDisaggregation) shows the availability of sex/age-disaggregated data by the global number of refugees and countries of asylum. Age- and sex-disaggregated data is available for `r round(sum(t.typeOfDisaggregation[t.typeOfDisaggregation$typeOfDisaggregation %in% c("Sex/Age broad", "Sex/Age fine"),]$freq.totalEndYear)*100,0)` per cent of the global refugee population and data disaggregated only by sex for a further `r round(t.typeOfDisaggregation[t.typeOfDisaggregation$typeOfDisaggregation %in% c("Sex"),]$freq.totalEndYear*100,0)` per cent.  

UNHCR has in the past reported the sex/age breakdown in the available data as global and regional aggregates of the demographic distribution of all refugees. Figure \@ref(fig:pobsDemographicsBroadshort) shows the proportion of female and male children and adults in the global refugee population with available demographic data, with `r round(sum(abs(t.obsDemographicsBroad.short[t.obsDemographicsBroad.short$age %in% c("children"),]$populationprop)),0)` per cent children under the age of 18 and `r round(sum(abs(t.obsDemographicsBroad.short[t.obsDemographicsBroad.short$sex %in% c("female"),]$populationprop)),0)` per cent women and girls among the population.

```{r  pobsDemographicsBroadshort, fig.height = 4, fig.width =5, fig.align='center', echo=F, fig.cap="Sex/age distribution of refugees with available data end 2020"}
 p.obsDemographicsBroad.short
``` 

In  figure \@ref(fig:pobsDemographicsBroadage)), we see the split between female and male refugees in each age bracket with available data, with a slight surplus of boys and men in all age groups up to 59 years and slightly more women than men among refugees aged 60 and older. 

```{r  pobsDemographicsBroadage, fig.height = 4, fig.width = 6, fig.align='center', echo=F, fig.cap="Sex distribution within age brackets of refugees with available data end 2020"}
 p.obsDemographicsBroad.age
``` 


By reporting the observed demographic distribution as the sex/age structure of the entire refugee population including the part without available data, we are assuming that the `r round(sum(t.typeOfDisaggregation[t.typeOfDisaggregation$typeOfDisaggregation %in% c("Sex", "None"),]$freq.totalEndYear)*100,0)` per cent for whom no age information was available at the end of 2020 have the same age distribution as the ones with available data. It is difficult to check this very strong assumption of ignorability of the missing data without further information on the sex/age distribution in the missing part of the data. We can however compare the distribution of other, fully available variables between refugees with and without demographic information. If such variables can be assumed to be correlated with the sex/age distribution at least to some extent, this can give us an indication whether the ignorability assumption is likely to be justified or not.   

In particular, we can look at the distribution of data availability by country and region of asylum, and we can furthermore compare the distribution of origins of refugees in the observed and the unobserved part of the population. If missingness of demographic data was entirely random and thus ignorable, we would expect the geographic origins of refugees to be similar in the observed and the unobserved part of the demographic data, that is, we would see a similar distribution of origin countries.  

Statelessness and the urban/rural variable are other variables for which we could in principle check distributions among refugees with and without observed demographic data. Variable _urbanRural_ however is not measured reliably in all reporting countries of asylum, and _statelessStatus_ can be assumed to suffer from underreporting that might be correlated with missingness in demographic data, making it a less than ideal measure of ignorability. We will therefore focus on the distribution of countries and regions of asylum and origin, both of which are measured reliably and with little missing data. Country of asylum is available for the entire population due to the way UNHCR's official population statistics are reported by country offices, and country of origin is available except for a very low proportion of refugees.  

Some questions we are particularly interested in answering through the following descriptive analysis:  

1. Can we assume that the sex/age distribution in the population with missing data is the same as in the population with available data?  
2. Is origin country a predictor of the demographic composition of refugee populations, even if they live in different countries of asylum?  
3. Is country of asylum a predictor of the demographic composition of refugee populations, even if they come from different countries of origin?  
4. Are refugee populations from the same country of origin similar to each other in neighbouring countries of asylum and in countries in the same region?  
5. Does the demographic distribution of a population from the same origin vary significantly across locations within the same country of asylum?  

Adressing these questions will help us decide whether the approach to date of assuming ignorability of missing demographic data is justified and if not, which modelling approaches can help us estimate the demographic distribution and variability of the missing data part.

### By region of origin

```{r poriregionhcrtypeOfDissaggregationBroad2, fig.height = 7, fig.width = 15, fig.align='center', echo=F, fig.cap="Proportion of refugees in each origin region by demographic data availability, end 2020"}
p.oriregionhcr.typeOfDissaggregationBroad2

```

Figure \@ref(fig:poriregionhcrtypeOfDissaggregationBroad2)) shows the distribution of refugees by origin regions separately for the two subsets of the global refugee population without (left side) and with (right side) sex/age-disaggregated data (population with sex- but not age-disaggregated data omitted for clarity). The most common origin regions are Sub-Saharan Africa and the MENA region for refugees with available demographic information.Those without demographic data availability have most commonly fled from countries in the Americas and the Asia-Pacific region. This provides a first indication that refugees with available sex/age-disaggregated data are fundamentally different from those without such data, and that we cannot simply assume the same demographic distribution between these two groups. 


### By region of asylum

```{r ptypeOfDissaggregationBroadasyregionhcr, fig.height = 7, fig.width = 15, fig.align='center', echo=F, fig.cap="Demographic disaggregation coverage by region of asylum"}
p.typeOfDissaggregationBroad.asyregionhcr

```

Figure \@ref(fig:ptypeOfDissaggregationBroadasyregionhcr)) shows for what proportion of the refugee population living in each region sex- and sex/age-disaggregated data was available at the end of 2020. While demographic coverage is close to universal for refugees hosted in the Sub-Saharan Africa and the MENA regions, it is available for `r round(t.typeOfDissaggregationBroad.asyregionhcr[t.typeOfDissaggregationBroad.asyregionhcr$typeOfDisaggregationBroad %in% c("Sex/Age")&t.typeOfDissaggregationBroad.asyregionhcr$asylum_hcr_region %in% c("Europe"),]$freq.totalEndYear*100,0)` per cent of refugees in Europe, `r round(t.typeOfDissaggregationBroad.asyregionhcr[t.typeOfDissaggregationBroad.asyregionhcr$typeOfDisaggregationBroad %in% c("Sex/Age")&t.typeOfDissaggregationBroad.asyregionhcr$asylum_hcr_region %in% c("Asia and the Pacific"),]$freq.totalEndYear*100,0)` per cent in Asia and the Pacific and only for `r round(t.typeOfDissaggregationBroad.asyregionhcr[t.typeOfDissaggregationBroad.asyregionhcr$typeOfDisaggregationBroad %in% c("Sex/Age")&t.typeOfDissaggregationBroad.asyregionhcr$asylum_hcr_region %in% c("Americas"),]$freq.totalEndYear*100,0)` per cent in the Americas. This is to a large extent a result of the differing population data sources in these regions: While the individual demographic details of refugees in many countries in Africa and MENA are recorded in UNHCR's own case registration system proGres, population data in other regions often comes from government offices with varying degrees of availability of demographic data. 

## Chord diagram for refugee flow within unhcr subregion, transparency related to the data coverage  
```{r pchorddiagram, message=F, fig.height = 7, fig.width = 15, fig.align='center', echo=F, fig.cap="Chord diagram"}
library(circlize)

findcolor <- function(i) {
  func <-colorRampPalette(c("#97e6f7", "#0000ff"))
  color <- func(100)[i]
  return(color)}

orig.dest.region <- demref2020 %>% mutate(origin_hcr_subregion = ifelse(is.na(as.character(origin_hcr_subregion)),'NA',as.character(origin_hcr_subregion))) %>%
  group_by(orig.region = origin_hcr_subregion,dest.region = asylum_hcr_subregion) %>%
  summarize(pop.mig = sum(totalEndYear)/1000,coverage = round(100*sum(totalEndYear[typeOfDisaggregationBroad == 'Sex/Age'], na.rm = T)/sum(totalEndYear, na.rm = T),1)) %>%
  arrange(desc(pop.mig)) %>% ungroup() %>% select(-coverage)
orig.dest.color <- demref2020 %>% mutate(origin_hcr_subregion = ifelse(is.na(as.character(origin_hcr_subregion)),'NA',as.character(origin_hcr_subregion))) %>%
  group_by(orig.region = origin_hcr_subregion,dest.region = asylum_hcr_subregion) %>%
  summarize(pop.mig = sum(totalEndYear)/1000,coverage = findcolor(round(100*sum(totalEndYear[typeOfDisaggregationBroad == 'Sex/Age'], na.rm = T)/sum(totalEndYear, na.rm = T),1))) %>%
  arrange(desc(pop.mig)) %>% ungroup() %>% pull(coverage)

circos.clear()
circos.par(start.degree = 90, canvas.ylim = c(-1.1,1.1), gap.degree = 4, track.margin = c(-0.1, 0.1), points.overflow.warning = FALSE)
par(mar = rep(1, 4))

# color palette
# colfunc <- colorRampPalette(c('#0083CF', "white"))
# 
# mycolor <- colfunc(length(concerned_ctries)+6)
#mycolor <- mycolor[sample(1:(length(concerned_ctries)+6))]

# Base plot
chordDiagram(
  x = orig.dest.region , 
  grid.col = '#0000ff',
  col = orig.dest.color,
  directional = 1,
  direction.type = c("arrows", "diffHeight"), 
  diffHeight  = -0.04,
  annotationTrack = "grid", 
  annotationTrackHeight = c(0.05, 0.1),
  link.arr.type = "big.arrow", 
  link.sort = TRUE, 
  link.largest.ontop = TRUE)

circos.trackPlotRegion(
  track.index = 1, 
  bg.border = NA, 
  panel.fun = function(x, y) {
    
    xlim = get.cell.meta.data("xlim")
    sector.index = get.cell.meta.data("sector.index")
    
    # Add names to the sector. 
    circos.text(
      x = mean(xlim), 
      y = 4, 
      labels = sector.index, 
      facing = "downward",
      niceFacing = T,
      cex = 0.7
    )
    
    # Add graduation on axis
    circos.axis(
      h = "top", 
      major.at = NULL,
      minor.ticks = 1, 
      major.tick.percentage = 0.5,
      labels.niceFacing = TRUE,
      labels.cex = 0.5)
  }
)
``` 


## Data coverage histogram  

```{r pcoverageDistributionasy, fig.height = 7, fig.width = 15, fig.align='center', echo=F, fig.cap="Data coverage histogram by country of asylum"}
p.coverageDistribution.asy
``` 

```{r pcoverageDistributionori, fig.height = 7, fig.width = 15, fig.align='center', echo=F, fig.cap="Data coverage histogram by country of origin"}
p.coverageDistribution.ori
```
  
The two figures above have shown drastic difference of distribution of data coverage between country of asylum and country of origin. When counted by country of asylum, the coverage is polarized, that is, for a single country of asylum, either the Sex/Age coverage is 0 or 100, while when counted by country of origin, the coverage numbers spread over 0 to 100 and concentrate on 0 side

## Demographic distribution from selected countries of origin
```{r ptotalEndYearoriasyreghcr, fig.height = 7, fig.width = 15, fig.align='center', echo=F, fig.cap="Demographic disaggregation coverage from selected countries of origin"}
p.totalEndYear.ori.asyreghcr

```  
Figure \@ref(fig:ptotalEndYearoriasyreghcr) shows the refugee population whose countries of origin is near Europe, Americas and Asia & Pacific bear the biggest missing of demographic data.  
```{r pdemCompSameOritop8, fig.height = 7, fig.width = 15, fig.align='center', echo=F, fig.cap="Demographic composition from same origin country and different asylum countries (Top 8 origin countries)"}
plot(p.demCompSameOri.top8)

```  
Figure \@ref(fig:pdemCompSameOritop8) shows that even from same origin country, the demographic composition may vary among different destinations. The most drastic situation is spotted in Somalia, where the refugees to South Africa are much more older than the refugees to Ethiopia, with the percentage of 18-59 age group 50% higher. This answers the question 2 above, that origin country may not be a good predictor of demographic composition.  

#### neighbor countries
```{r pdemCompSameOritop8nei, fig.height = 7, fig.width = 15, fig.align='center', echo=F, fig.cap="Demographic composition from same asylum country and different origin countries (Top 8 asylum countries)"}
plot(p.demCompSameOri.top8.nei)

```  

## Demographic distribution in selected countries of asylum
```{r ptotalEndYearasyorireghcr, fig.height = 7, fig.width = 15, fig.align='center', echo=F, fig.cap="Demographic disaggregation coverage from selected countries of origin"}
p.totalEndYear.asy.orireghcr
```  
Figure \@ref(fig:ptotalEndYearasyorireghcr) shows that all of the top 8 asylum countries has nearly 100% demographic data. Even Germany is an european country.
```{r pdemCompSameAsytop8, fig.height = 7, fig.width = 15, fig.align='center', echo=F, fig.cap="Demographic composition from same asylum country and different origin countries (Top 8 asylum countries)"}
plot(p.demCompSameAsy.top8)

```  
Figure \@ref(fig:pdemCompSameOritop8) shows that from the perspective of asylum country, the situation is more complicated. Out of the 8 biggest receiving countries, 3 (Turkey, Pakistan and Bangladesh) only have single source of inflow. The rest of the refugee inflows either have <50% data coverage or less than 1000 total population. Even for the rest of asylum countries that have multiple inflows, the demographic compositions still differ among different origins. The most drastic situation is spotted in Sudan, where the refugees from Central African Republic are much more younger than the refugees from Ethiopia, with the percentage of 18-59 age group 35% lower. This answers the question 3 above, that origin country may not be a good predictor of demographic composition.

## Compare refugee population's age distribution with origin and asylum country's age distribution
```{r pageDistribution, fig.height = 7, fig.width = 15, fig.align='center', echo=F, fig.cap="Compare demographic distribution from selected countries"}
p.ageDistribution
```  






